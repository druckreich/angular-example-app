version: 2
jobs:
  build:
    working_directory: ~/app-name
    docker:
      - image: circleci/node:9.5.0
    steps:
      - checkout
      - restore_cache:
          keys:
            - dependency-cache-{{ checksum "package.json" }}
            - dependency-cache-
      - run:
          name: check versions before update
          command: |
            node --version
            npm --version
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - ~/app-name/node_modules/
      - run: npm install
      - run:
          name: angular-build
          command: npm run ng build

  deploy:
    machine:
      services:
        - docker
        dependencies:
          override:
            - docker info
            - docker build --rm=false -t druckreich/angular-example-app .

        test:
          override:
            - docker run -d -p 9200:9200 druckreich/angular-example-app; sleep 10
            - curl --retry 10 --retry-delay 5 -v http://localhost:9200

        deployment:
          hub:
            branch: master
            commands:
              - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
              - docker push druckreich/angular-example-app

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - deploy
